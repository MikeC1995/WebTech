<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <base href="/">
    <title>TripMappr</title>
    <meta name="description" content="Put your memories on the map.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Styles -->
    <link rel="stylesheet" href="/assets/styles/css/app.css">
  </head>

  <body ng-app="landing" ng-controller="appController">
    <nav></nav>
    <header>
      <h1>tripmappr</h1>
      <h2>Welcome to</h2>
      <img src="/assets/images/logo-white.png">
      <img id="globe" src="/assets/images/globe.png">
      <img id="anchor1" src="/assets/images/anchor1.png">
      <img id="anchor2" src="/assets/images/anchor2.png">
    </header>

    <div class="content" id="intro">
      <h2>Love to travel?</h2>
      <h3>Put your memories on the map.</h3>
      <div id="canvas-container">
        <img id="map" src="/assets/images/map.svg">
        <img id="london" class="place" src="/assets/images/london.png">
        <img id="paris" class="place" src="/assets/images/paris.png">
        <img id="berlin" class="place" src="/assets/images/berlin.png">
        <img id="budapest" class="place" src="/assets/images/budapest.png">
        <img id="croatia" class="place" src="/assets/images/croatia.png">
        <canvas id="map-canvas"></canvas>
      </div>
    </div>
    <div class="content" id="how-it-works">
      <h2>How it works</h2>
      <ul class="clearfix">
        <li><span>Create a trip</span><span class="number">1</span></li>
        <li><span>Add places</span><span class="number">2</span></li>
        <li><span>Add photos</span><span class="number">3</span></li>
        <li><span>Relive your experiences!</span><span class="number">4</span></li>
      </ul>
    </div>
    <div class="content layout1 clearfix" id="sharing-experiences">
      <div class="content-text">
        <h2>Share your experiences</h2>
        <p>Travelling makes the best memories. Do them justice by sharing on a sleek, interactive map - it's as easy as copy-paste.</p>
      </div>
      <div class="content-image"></div>
    </div>
    <div class="content layout1 clearfix" id="for-friends">
      <div class="content-image"></div>
      <div class="content-text">
        <h2>Made for friends</h2>
        <p>Met some awesome people while out there? Sweet. Collaborative trips let you sync up your maps, so your experiences are all in one place.</p>
      </div>
    </div>
    <div class="content layout1 clearfix" id="discover">
      <div class="content-text">
        <h2>Discover your next trip</h2>
        <p>Explore our hand-curated maps to discover the best adventures out there, all over the world. Tripmappr makes sure that your next trip is your best yet.</p>
      </div>
      <div class="content-image"></div>
    </div>
    <div id="sign-up">
      <h2>Interested?</h2>
      <h3>Sign up below and you'll be the first to know when we launch!</h3>
      <form>
        <input type="text" placeholder="Name"></input>
        <input type="email" placeholder="Email"></input>
        <button type="submit"><span>SIGN UP</span></button>
      </form>
    </div>

    <!-- Dependencies -->
    <script src="/npm_scripts/jquery/dist/jquery.min.js"></script>
    <script src="/npm_scripts/angular/angular.min.js"></script>
    <script src="/npm_scripts/angular-ui-router/release/angular-ui-router.min.js"></script>
    <script src="/bower_scripts/angular-animate/angular-animate.min.js"></script>

    <!-- ROOT -->
    <script src="/app/app.js"></script>
    <script>

      // Returns true if the specified element has been scrolled into the viewport.
      function isElementInViewport(elem) {
        var $elem = $(elem);

        // Get the scroll position of the page.
        var scrollElem = ((navigator.userAgent.toLowerCase().indexOf('webkit') != -1) ? 'body' : 'html');
        var viewportTop = $(scrollElem).scrollTop();
        var viewportBottom = viewportTop + $(window).height();

        // Get the position of the element on the page.
        var elemTop = Math.round( $elem.offset().top );
        var elemBottom = elemTop + $elem.height();

        return ((elemTop < viewportBottom) && (elemBottom > viewportTop));
      }

      // Check if it's time to start the animation.
      function checkAnimations() {
        // register elements to be animated
        var elements = [$("#content #why-it-works div:nth-of-type(1)"),
                        $("#content #why-it-works div:nth-of-type(2)"),
                        $("#content #why-it-works div:nth-of-type(3)"),
                        $("#content #content-intro img"),
                        $(".layout-quote-image > div:nth-of-type(2) img"),
                        $("#content #content-theres-more > div")];

        // animate each element (a single selector above may select multiple elements)
        for(var i = 0; i < elements.length; i++) {
          elements[i].each(function() {
            // If the animation has already been started
            if ($(this).hasClass('start')) return;
            if (isElementInViewport($(this))) {
              // Start the animation
              $(this).addClass('start');
            }
          });
        }
      }

      $(map).load(function() {
        // Create canvas & context
        var canvasContainer = document.getElementById('canvas-container');
        var canvas = document.getElementById('map-canvas');
        var context = canvas.getContext('2d');
        var iconRadius, points;
        var t = 1;
        var resolution = 50;

        initialize();
  			function initialize() {
  				window.addEventListener('resize', redraw, false);
  			}

        // Capture scroll events
        $(window).scroll(function() {
          checkAnimations();
        });

        // If animation not yet happened, invoke it and then add 'drawn' class
        // to canvasContainer to prevent re-animating
        function checkAnimations() {
          if($(canvasContainer).hasClass('drawn')) return;
          if(isElementInViewport($(canvasContainer))) {
            redraw();
            $(canvasContainer).addClass('drawn');
          }
        }

        // redraw the canvas with updated dimensions
  			function redraw() {
  				canvas.width = $(canvasContainer).width();
  				canvas.height = $(canvasContainer).height();
          iconRadius = (0.08 * canvas.width)/2;
          t = 1;
  				drawLines();
  			}

        // convert points written in percentages to actual canvas coordinates
        function percentagesToPoints(vertices) {
          var newVertices = [];
          for(var i = 0; i < vertices.length; i++){
            newVertices.push({
              x: vertices[i].x * canvas.width + iconRadius,
              y: vertices[i].y * canvas.height + iconRadius,
              id: vertices[i].id
            });
          }
          return newVertices;
        }

        // subdivide vertices of line segments into small chunks in order to animate line drawing
        function animatablePoints(vertices) {
          var waypoints = [];
          for(var i = 1; i < vertices.length; i++){
            var pt0 = vertices[i-1];
            var pt1 = vertices[i];
            var dx = pt1.x - pt0.x;
            var dy = pt1.y - pt0.y;
            for(var j = 0; j < resolution; j++) {
              var x = pt0.x + dx * j / resolution;
              var y = pt0.y + dy * j / resolution;
              if(j == resolution-1) {
                waypoints.push({ x: x, y: y, id: pt1.id });
              } else {
                waypoints.push({ x: x, y: y });
              }
            }
          }
          return waypoints;
        }

        // incrementally draw additional line segments along the path
        function animate() {
          if(t < points.length - 1) {
            requestAnimationFrame(animate);
          }

          context.beginPath();
          context.moveTo(points[t-1].x,points[t-1].y);
          context.lineTo(points[t].x,points[t].y);
          context.stroke();
          // id property is appended to points[t] if this is the last line segment of the animation
          if(points[t].id) {
            // add draw class to the image element so that it animates into view
            var elem = $('#' + points[t].id);
            elem.addClass('draw');
          }
          t++;
        }

        // draw the lines connecting the points on the canvas, animating them
        // if not yet drawn before.
        function drawLines() {
          // line segment vertices in percentages (corresponding to img
          // top and left offsets)
          points = [{
            x: 0.20, y: 0.35, id: 'london'
          },{
            x: 0.27, y: 0.5, id: 'paris'
          },{
            x: 0.45, y: 0.4, id: 'berlin'
          },{
            x: 0.6, y: 0.55, id: 'budapest'
          },{
            x: 0.55, y: 0.7, id: 'croatia'
          }];
          points = percentagesToPoints(points);
          if(!$(canvasContainer).hasClass('drawn')) {
            points = animatablePoints(points);
          }
          context.lineWidth = 10;
          context.strokeStyle = '#d12e2e';
          animate();
        }
      });
    </script>
  </body>
</html>
